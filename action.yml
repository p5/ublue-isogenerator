name: Release ISO
description: 'Build and release an ISO'

inputs:
  image-name:
    description: 'Name of the image to build'
    required: true
  installer-major-version:
    description: 'Major version of the installer to use'
    required: true
  kickstart-file-path:
    description: 'Path to the kickstart file'
    required: true
  upload-artifact:
    description: 'Upload the artifact to the workflow'
    required: false
    default: 'false'
  release-artifact:
    description: 'Upload the artifact to the release'
    required: false
    default: 'false'
  git-tag:
    description: 'Git tag to use for the release.  Required if release-artifact is true.'
    required: false
  github-token:
    description: 'GitHub token to use for the release.  Required if release-artifact is true.'
    required: false

outputs:
  iso-path:
    description: 'Path to the ISO file'
    value: ${{ env.ISO_FILENAME }}

runs:
  using: composite
  steps:
    - name: Install Dependencies
      shell: bash
      run: |
        dnf install -y lorax curl 
        dnf install -y 'dnf-command(config-manager)'
        dnf config-manager --add-repo https://cli.github.com/packages/rpm/gh-cli.repo
        dnf install -y gh

    - name: Download Fedora Everything Installer
      shell: bash
      run: |
        curl -L $EVERYTHING_INSTALLER_URL -o Fedora-Everything-netinst-x86_64.iso
      env:
        EVERYTHING_INSTALLER_URL: https://download.fedoraproject.org/pub/fedora/linux/releases/${{ inputs.installer-major-version }}/Everything/x86_64/os/images/boot.iso

    - name: Build ISO
      shell: bash
      run: |
        mkksiso --ks ${{ inputs.kickstart-file-path }} Fedora-Everything-netinst-x86_64.iso ${{ inputs.image-name }}.iso

    - name: Upload to release
      shell: bash
      if: ${{ inputs.release-artifact }}
      run: |
        echo "PWD: $PWD"
        ls -la
        git status
        gh release upload ${{ inputs.git-tag }} ${{ inputs.image-name }}.iso --clobber
      env:
        GH_TOKEN: ${{ inputs.github-token }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      if: ${{ inputs.upload-artifact }}
      with:
        name: ${{ inputs.image-name }}
        path: |
          ${{ inputs.image-name }}.iso
