on:
  workflow_call:
    inputs:
      image-name:
        description: 'Name of the image to build'
        required: true
        type: string
      fedora-version:
        description: 'Fedora version to build'
        required: true
        type: string
      git-tag:
        description: 'Git tag to build'
        required: true
        type: string
      #cosign-public-key-path:
      #  description: 'Path to public GPG key'
      #  required: true
      #  secret: true
      #  type: string
    #secrets:
    #  cosign-private-key:
    #    description: 'Cosign private key'
    #    required: true

env:
  EVERYTHING_INSTALLER_URL: https://download.fedoraproject.org/pub/fedora/linux/releases/${{ inputs.fedora-version }}/Everything/x86_64/iso/Fedora-Everything-netinst-x86_64-${{ inputs.fedora-version }}.iso

jobs:
  build-iso:
    runs-on: ubuntu-latest
    env:
      ISO_FILENAME: ${{ inputs.image-name }}-${{ inputs.fedora-version }}.iso
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.git-tag }}

      - name: Pull Fedora Everything Installer ISO
        run: |
          mkdir -p /tmp/iso
          curl -L $EVERYTHING_INSTALLER_URL -o /tmp/iso/Fedora-Everything-netinst-x86_64.iso

      - name: Build ISO
        run: |
          mkksiso ublue.ks Fedora-Everything-netinst-x86_64.iso ${{ env.ISO_FILENAME }}

      - name: Setup Cosign
        if: false
        uses: sigstore/cosign-installer@3
        with:
          cosign-release: 'v2.0.0'

      - name: Sign ISO
        if: false
        run: |
          cosign sign blob -key ${{ secrets.cosign-private-key }} --output-signature ${{ env.ISO_FILENAME }}.sig ${{ env.ISO_FILENAME }}
        env:
          COSIGN_PRIVATE_KEY: ${{ secrets.cosign-private-key }}

      - name: Verify ISO
        if: false
        run: |
          cosign verify-blob --key ${{ inputs.gpg-key }} --signature $(${{ env.ISO_FILENAME }}.sig) ${{ env.ISO_FILENAME }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ inputs.image-name }}-${{ inputs.fedora-version }}
          path: |
            ${{ inputs.image-name }}-${{ inputs.fedora-version }}.iso

  publish-iso:
    needs: build-iso
    runs-on: ubuntu-latest
    if: false
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.git-tag }}

      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ inputs.image-name }}-${{ inputs.fedora-version }}.iso

      - name: Attach Artifact to Release
        run: |
          echo "Publishing ${{ inputs.image-name }}-${{ inputs.fedora-version }}.iso"
          gh release upload ${{ inputs.git-tag }} ${{ inputs.image-name }}-${{ inputs.fedora-version }}.iso
