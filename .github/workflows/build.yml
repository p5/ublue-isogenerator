on:
  workflow_call:
    inputs:
      image-name:
        description: 'Name of the image to build'
        required: true
        type: string
      installer-version:
        description: 'Installer version to use'
        required: true
        type: string
      git-tag:
        description: 'Git tag to build'
        required: true
        type: string
      kickstart-file-path:
        description: 'Path to the kickstart file'
        required: true
        type: string

env:
  # Extract the major version from the installer version (e.g. 37-1.7 -> 37)
  EVERYTHING_INSTALLER_MAJOR_VERSION: ${{ inputs.installer-version.split('-')[0] }}
  EVERYTHING_INSTALLER_URL: https://download.fedoraproject.org/pub/fedora/linux/releases/${{ env.EVERYTHING_INSTALLER_MAJOR_VERSION }}/Everything/x86_64/iso/Fedora-Everything-netinst-x86_64-${{ inputs.installer-version }}.iso
  ISO_FILENAME: ${{ inputs.image-name }}.iso
  ARTIFACT_NAME: ${{ inputs.image-name }}

jobs:
  build-iso:
    runs-on: ubuntu-latest
    container: fedora:latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        #with:
        #  ref: ${{ inputs.git-tag }}

      - name: Pull Fedora Everything Installer ISO
        run: |
          curl -L $EVERYTHING_INSTALLER_URL -o Fedora-Everything-netinst-x86_64.iso

      - name: Install Dependencies
        run: |
          dnf install -y lorax

      - name: Build ISO
        run: |
          mkksiso --ks ${{ inputs.kickstart-file-path }} Fedora-Everything-netinst-x86_64.iso ${{ env.ISO_FILENAME }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            ${{ env.ISO_FILENAME }}

  publish-iso:
    needs: build-iso
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.git-tag }}

      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ env.ARTIFACT_NAME }}

      - name: Attach Artifact to Release
        run: |
          gh release upload ${{ inputs.git-tag }} ${{ env.ISO_FILENAME }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
